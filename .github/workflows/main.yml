name: Build APK/AAB MediaVerse

on:
  repository_dispatch:
    types: [build_apk, build_aab]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Notify via Telegram that the build has started
      - name: Notify start of build
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          CHAT_ID=${{ github.event.client_payload.chat_id }}
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="🚀 Build started for ${{ github.event.action }}. Initializing environment..."

      # Cache Flutter SDK
      - name: Cache Flutter SDK
        uses: actions/cache@v3
        with:
          path: ~/.flutter
          key: flutter-sdk-${{ runner.os }}-${{ hashFiles('pubspec.yaml') }}
          restore-keys: |
            flutter-sdk-${{ runner.os }}-
      
      # Notify that Flutter setup is in progress
      - name: Notify Flutter setup
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          CHAT_ID=${{ github.event.client_payload.chat_id }}
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="⚙️ Setting up Flutter environment..."

      # Setup Flutter environment
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: 3.22.0

      # Notify that Android SDK is being set up
      - name: Notify Android SDK setup
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          CHAT_ID=${{ github.event.client_payload.chat_id }}
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="📱 Setting up Android SDK..."

      # Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 34
          target: default
          arch: x86_64
          ndk: true

      # Notify that the dependencies are being installed
      - name: Notify dependencies installation
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          CHAT_ID=${{ github.event.client_payload.chat_id }}
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="📦 Installing dependencies..."

      # Get dependencies
      - name: Get dependencies
        run: flutter pub get

      # Notify that the build process is starting
      - name: Notify build process
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          CHAT_ID=${{ github.event.client_payload.chat_id }}
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="🔨 Building ${{ github.event.action }} (APK or AAB)..."

      # Build based on event type (APK or AAB)
      - name: Build APK or AAB
        run: |
          if [ "${{ github.event.action }}" == "build_apk" ]; then
            flutter build apk --release --split-per-abi
          elif [ "${{ github.event.action }}" == "build_aab" ]; then
            flutter build appbundle --release
          fi

      # Notify that the signing process is starting
      - name: Notify signing process
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          CHAT_ID=${{ github.event.client_payload.chat_id }}
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="🔑 Signing ${{ github.event.action }}..."

      # Decode keystore
      - name: Decode keystore
        env:
          KEYSTORE_FILE_BASE64: ${{ secrets.KEYSTORE_FILE_BASE64 }}
        run: |
          echo "$KEYSTORE_FILE_BASE64" | base64 --decode > android/app/keystore.jks

      # Sign APK or AAB
      - name: Sign APK or AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ "${{ github.event.action }}" == "build_apk" ]; then
            for APK in build/app/outputs/apk/release/*.apk; do
              jarsigner -verbose -keystore android/app/keystore.jks -storepass "$KEYSTORE_PASSWORD" -keypass "$KEY_PASSWORD" "$APK" "$KEY_ALIAS"
            done
          elif [ "${{ github.event.action }}" == "build_aab" ]; then
            jarsigner -verbose -keystore android/app/keystore.jks -storepass "$KEYSTORE_PASSWORD" -keypass "$KEY_PASSWORD" build/app/outputs/bundle/release/app-release.aab "$KEY_ALIAS"
          fi

      # Align APK (if APK is built)
      - name: Zipalign APK (if APK is built)
        if: github.event.action == 'build_apk'
        run: |
          for APK in build/app/outputs/apk/release/*.apk; do
            zipalign -v 4 "$APK" "$APK-aligned.apk"
            mv "$APK-aligned.apk" "$APK"
          done

      # Notify completion of the build and share the APK/AAB
      - name: Notify completion and send APK/AAB to Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          CHAT_ID=${{ github.event.client_payload.chat_id }}

          if [ "${{ github.event.action }}" == "build_apk" ]; then
            for APK in build/app/outputs/apk/release/*.apk; do
              curl -F chat_id=$CHAT_ID -F document=@"$APK" -F caption="✅ APK build completed! Here is your APK file." https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument
            done
          elif [ "${{ github.event.action }}" == "build_aab" ]; then
            curl -F chat_id=$CHAT_ID -F document=@"build/app/outputs/bundle/release/app-release.aab" -F caption="✅ AAB build completed! Here is your AAB file." https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument
          fi
